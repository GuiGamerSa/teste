<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Sistema Inform√°tico da UPA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
      padding: 2rem;
    }
    iframe {
      width: 100%;
      height: 600px;
      border: none;
      margin-top: 2rem;
    }
  </style>
</head>
<body>
  <div class="container text-center">
    <h1 class="mb-4">üëã Bem-vindo ao Sistema Inform√°tico da UPA</h1>

    <div id="userInfo" class="mb-3"></div>

    <button id="loginBtn" class="btn btn-primary">Login com Discord</button>
    <button id="registerBtn" class="btn btn-success d-none" data-bs-toggle="modal" data-bs-target="#relatorioModal">Registrar Relat√≥rio de Consulta</button>
    <button id="logoutBtn" class="btn btn-danger d-none">Logout</button>

    <!-- Google Sheets -->
    <iframe src="https://docs.google.com/spreadsheets/d/e/2PACX-1vRmq6bl99xb_YqME4AzXW9ASRpC3Qz3hTn4x5Sv4SyoI-OUlGgHC9V8DsC6VnbOe8fLhNgAbv0kvo9M/pubhtml?gid=1539016408&single=true&widget=true&headers=false"></iframe>
  </div>

  <!-- Modal Relat√≥rio -->
  <div class="modal fade" id="relatorioModal" tabindex="-1" aria-labelledby="relatorioModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form id="relatorioForm" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="relatorioModalLabel">Registrar Relat√≥rio</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-start">
          <div class="mb-2">
            <label>Nome do Paciente</label>
            <input type="text" class="form-control" id="pacienteNome" required>
          </div>
          <div class="mb-2">
            <label>ID do Paciente</label>
            <input type="text" class="form-control" id="pacienteId" required>
          </div>
          <div class="mb-2">
            <label>Sintomas</label>
            <textarea class="form-control" id="sintomas" required></textarea>
          </div>
          <div class="mb-2">
            <label>Medicamentos</label>
            <textarea class="form-control" id="medicamentos" required></textarea>
          </div>
          <div class="mb-2">
            <label>Hor√°rio</label>
            <input type="text" class="form-control" id="horario" required>
          </div>
          <div class="mb-2">
            <label>Data</label>
            <input type="text" class="form-control" id="data" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Enviar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const CLIENT_ID = "1401008725824770088";
    const REDIRECT_URI = "https://guigamersa.github.io/teste/";
    const API_ENDPOINT = "https://discord.com/api/users/@me";
    const SCOPE = "identify";
    const WEBHOOK_URL = "https://discord.com/api/webhooks/1401004679005081672/5n0r7NEXpMnmYfTLtJWKH0j3RhPHxHzxXbkxlDlfoQXbFopCQUkE_bPO6plocDLZO75F"; // ‚Üê substitui aqui

    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const registerBtn = document.getElementById("registerBtn");
    const userInfo = document.getElementById("userInfo");

    let userData = null;

    function getAccessTokenFromUrl() {
      const hash = window.location.hash;
      if (!hash) return null;
      const params = new URLSearchParams(hash.substring(1));
      return params.get("access_token");
    }

    async function fetchDiscordUser(token) {
      const response = await fetch(API_ENDPOINT, {
        headers: { Authorization: `Bearer ${token}` },
      });
      if (!response.ok) throw new Error("Erro ao obter dados do Discord");
      return await response.json();
    }

    async function handleLogin() {
      const token = getAccessTokenFromUrl();
      if (!token) return;

      window.history.replaceState({}, document.title, REDIRECT_URI);
      try {
        const user = await fetchDiscordUser(token);
        userData = user;

        loginBtn.classList.add("d-none");
        registerBtn.classList.remove("d-none");
        logoutBtn.classList.remove("d-none");

        userInfo.innerHTML = `
          <h4>üë§ Logado como ${user.username}#${user.discriminator}</h4>
          <p>ID: ${user.id}</p>
        `;
      } catch (e) {
        console.error(e);
        alert("Falha ao autenticar com o Discord.");
      }
    }

    loginBtn.addEventListener("click", () => {
      const url = `https://discord.com/api/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=token&scope=${SCOPE}`;
      window.location.href = url;
    });

    logoutBtn.addEventListener("click", () => {
      window.location.href = REDIRECT_URI;
    });

    document.getElementById("relatorioForm").addEventListener("submit", function (e) {
      e.preventDefault();

      const pacienteNome = document.getElementById("pacienteNome").value;
      const pacienteId = document.getElementById("pacienteId").value;
      const sintomas = document.getElementById("sintomas").value;
      const medicamentos = document.getElementById("medicamentos").value;
      const horario = document.getElementById("horario").value;
      const data = document.getElementById("data").value;

      const embed = {
        title: "üìã Relat√≥rio M√©dico",
        color: 0x00b0f4,
        fields: [
          { name: "üë®‚Äç‚öïÔ∏è Nome M√©dico", value: `<@${userData.id}> | ${userData.id}`, inline: false },
          { name: "üÜî ID M√©dico", value: `${userData.id}`, inline: true },
          { name: "üë§ Nome Paciente", value: pacienteNome, inline: false },
          { name: "üÜî ID Paciente", value: pacienteId, inline: true },
          { name: "ü§í Sintomas", value: sintomas, inline: false },
          { name: "üíä Medicamentos", value: medicamentos, inline: false },
          { name: "üïì Hor√°rio", value: horario, inline: true },
          { name: "üìÖ Dia", value: data, inline: true },
        ],
        footer: {
          text: "Sistema UPA",
        },
        timestamp: new Date().toISOString()
      };

      fetch(WEBHOOK_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ embeds: [embed] })
      }).then(res => {
        if (res.ok) {
          alert("‚úÖ Relat√≥rio enviado com sucesso!");
          document.getElementById("relatorioForm").reset();
          bootstrap.Modal.getInstance(document.getElementById('relatorioModal')).hide();
        } else {
          alert("‚ùå Erro ao enviar o relat√≥rio.");
        }
      });
    });

    handleLogin();
  </script>
</body>
</html>
