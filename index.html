<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Sistema Inform√°tico da UPA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      padding: 2rem;
      background-color: #f8f9fa;
    }
    iframe {
      width: 100%;
      height: 600px;
      border: none;
      margin-top: 2rem;
    }
  </style>
</head>
<body>

  <div class="container text-center">
    <h1 class="mb-4">üëã Bem-vindo ao Sistema Inform√°tico da UPA</h1>

    <div id="userInfo" class="mb-4"></div>

    <button id="loginBtn" class="btn btn-primary">Login com Discord</button>
    <button id="registerBtn" class="btn btn-success d-none" data-bs-toggle="modal" data-bs-target="#relatorioModal">Registrar Relat√≥rio de Consulta</button>
    <button id="logoutBtn" class="btn btn-danger d-none">Logout</button>

    <iframe src="https://docs.google.com/spreadsheets/d/e/2PACX-1vTrlfALkd8jZi9UFb_qSFIwRmCLcD-SK7E-Vwp2_ws2-ZnhUl8qxcpOPdXf6wgpoZwOdjCI2cpZbMg1/pubhtml?gid=1539016408&amp;single=true&amp;widget=true&amp;headers=false"></iframe>
  </div>

  <!-- Modal para Relat√≥rio -->
  <div class="modal fade" id="relatorioModal" tabindex="-1" aria-labelledby="relatorioModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content text-start">
        <div class="modal-header">
          <h5 class="modal-title" id="relatorioModalLabel">Registrar Relat√≥rio</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="relatorioForm">
            <input type="hidden" id="medicoId">
            <div class="mb-2">
              <label class="form-label">Nome M√©dico</label>
              <input type="text" class="form-control" id="nomeMedico" readonly>
            </div>
            <div class="mb-2">
              <label class="form-label">Nome Paciente</label>
              <input type="text" class="form-control" id="nomePaciente" required>
            </div>
            <div class="mb-2">
              <label class="form-label">ID Paciente</label>
              <input type="number" class="form-control" id="idPaciente" required>
            </div>
            <div class="mb-2">
              <label class="form-label">Sintomas</label>
              <textarea class="form-control" id="sintomas" required></textarea>
            </div>
            <div class="mb-2">
              <label class="form-label">Medicamentos</label>
              <textarea class="form-control" id="medicamentos" required></textarea>
            </div>
            <div class="mb-2">
              <label class="form-label">Hor√°rio</label>
              <input type="time" class="form-control" id="horario" required>
            </div>
            <div class="mb-2">
              <label class="form-label">Dia</label>
              <input type="date" class="form-control" id="dia" required>
            </div>
            <button type="submit" class="btn btn-success w-100 mt-3">Enviar Relat√≥rio</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts Bootstrap -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const CLIENT_ID = "1401008725824770088";
    const REDIRECT_URI = "https://guigamersa.github.io/teste/";
    const SCOPE = "identify";
    const DISCORD_API = "https://discord.com/api/users/@me";
    const WEBHOOK_URL = "https://discord.com/api/webhooks/1401004679005081672/5n0r7NEXpMnmYfTLtJWKH0j3RhPHxHzxXbkxlDlfoQXbFopCQUkE_bPO6plocDLZO75F";

    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const registerBtn = document.getElementById("registerBtn");
    const userInfo = document.getElementById("userInfo");

    const getAccessToken = () => {
      const hash = window.location.hash;
      if (!hash) return null;
      return new URLSearchParams(hash.slice(1)).get("access_token");
    };

    const fetchDiscordUser = async (token) => {
      const res = await fetch(DISCORD_API, {
        headers: { Authorization: `Bearer ${token}` }
      });
      if (!res.ok) throw new Error("Falha ao obter dados do Discord");
      return await res.json();
    };

    const init = async () => {
      const token = getAccessToken();
      if (!token) return;

      window.history.replaceState({}, document.title, REDIRECT_URI);
      try {
        const user = await fetchDiscordUser(token);
        loginBtn.classList.add("d-none");
        registerBtn.classList.remove("d-none");
        logoutBtn.classList.remove("d-none");

        document.getElementById("nomeMedico").value = `@[UPA] C. Enfer. ${user.username} | ${user.discriminator}`;
        document.getElementById("medicoId").value = user.id;

        userInfo.innerHTML = `
          <h4>üë§ Logado como ${user.username}#${user.discriminator}</h4>
          <p>ID: ${user.id}</p>
        `;
      } catch (err) {
        alert("Erro ao autenticar com o Discord.");
      }
    };

    loginBtn.addEventListener("click", () => {
      const oauthURL = `https://discord.com/api/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=token&scope=${SCOPE}`;
      window.location.href = oauthURL;
    });

    logoutBtn.addEventListener("click", () => {
      window.location.href = REDIRECT_URI;
    });

    document.getElementById("relatorioForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const nomeMedico = document.getElementById("nomeMedico").value;
      const idMedico = document.getElementById("medicoId").value;
      const nomePaciente = document.getElementById("nomePaciente").value;
      const idPaciente = document.getElementById("idPaciente").value;
      const sintomas = document.getElementById("sintomas").value;
      const medicamentos = document.getElementById("medicamentos").value;
      const horario = document.getElementById("horario").value;
      const dia = document.getElementById("dia").value;

      const embed = {
        embeds: [{
          title: "üìã Relat√≥rio de Consulta",
          color: 0x57F287,
          fields: [
            { name: "üë®‚Äç‚öïÔ∏è Nome M√©dico", value: `<@${idMedico}>`, inline: true },
            { name: "üÜî ID M√©dico", value: idMedico, inline: true },
            { name: "üë§ Nome Paciente", value: nomePaciente, inline: true },
            { name: "üÜî ID Paciente", value: idPaciente, inline: true },
            { name: "ü§ï Sintomas", value: sintomas },
            { name: "üíä Medicamentos", value: medicamentos },
            { name: "üïí Hor√°rio", value: horario, inline: true },
            { name: "üìÖ Dia", value: dia, inline: true }
          ],
          timestamp: new Date().toISOString()
        }]
      };

      const res = await fetch(WEBHOOK_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(embed)
      });

      if (res.ok) {
        alert("Relat√≥rio enviado com sucesso!");
        document.getElementById("relatorioForm").reset();
        const modal = bootstrap.Modal.getInstance(document.getElementById("relatorioModal"));
        modal.hide();
      } else {
        alert("Erro ao enviar relat√≥rio.");
      }
    });

    init();
  </script>

</body>
</html>
