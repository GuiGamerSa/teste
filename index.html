<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UPA - Sistema Inform√°tico</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">

  <nav class="navbar navbar-expand-lg navbar-dark bg-primary px-4">
    <a class="navbar-brand" href="#">Sistema Inform√°tico da UPA</a>
    <div class="ms-auto">
      <button id="loginBtn" class="btn btn-light">Login Discord</button>
      <button id="logoutBtn" class="btn btn-light d-none">Logout</button>
    </div>
  </nav>

  <div id="mainContent" class="container mt-5 text-center">
    <h1>Bem-vindo ao Sistema Inform√°tico da UPA</h1>
    <div class="mt-4">
      <iframe 
        src="https://docs.google.com/spreadsheets/d/e/2PACX-1vTrlfALkd8jZi9UFb_qSFIwRmCLcD-SK7E-Vwp2_ws2-ZnhUl8qxcpOPdXf6wgpoZwOdjCI2cpZbMg1/pubhtml?gid=1539016408&amp;single=true&amp;widget=true&amp;headers=false"
        style="width:100%; height:600px; border:none;"
        title="Google Sheets UPA">
      </iframe>
    </div>
  </div>

  <div id="formContainer" class="container mt-5 d-none">
    <div class="card shadow">
      <div class="card-body">
        <h3 class="card-title mb-4">üìã Registrar Relat√≥rio de Consulta</h3>
        <form id="relatorioForm">
          <div class="mb-3">
            <label for="medicoId" class="form-label">ID M√©dico</label>
            <input type="text" class="form-control" id="medicoId" required />
          </div>
          <div class="mb-3">
            <label for="nomePaciente" class="form-label">Nome Paciente</label>
            <input type="text" class="form-control" id="nomePaciente" required />
          </div>
          <div class="mb-3">
            <label for="idPaciente" class="form-label">ID Paciente</label>
            <input type="number" class="form-control" id="idPaciente" required />
          </div>
          <div class="mb-3">
            <label for="sintomas" class="form-label">Sintomas</label>
            <textarea class="form-control" id="sintomas" rows="2" required></textarea>
          </div>
          <div class="mb-3">
            <label for="medicamentos" class="form-label">Medicamentos</label>
            <textarea class="form-control" id="medicamentos" rows="2" required></textarea>
          </div>
          <div class="mb-3">
            <label for="horario" class="form-label">Hor√°rio</label>
            <input type="time" class="form-control" id="horario" required />
          </div>
          <div class="mb-3">
            <label for="dia" class="form-label">Dia</label>
            <input type="date" class="form-control" id="dia" required />
          </div>
          <button type="submit" class="btn btn-success w-100">Enviar Relat√≥rio</button>
        </form>
      </div>
    </div>
  </div>

<script>
  // Configura√ß√µes - substitua pelos seus dados
  const clientId = '1401008725824770088'; 
  const redirectUri = window.location.origin + window.location.pathname;
  const webhookURL = 'https://discord.com/api/webhooks/1401004679005081672/5n0r7NEXpMnmYfTLtJWKH0j3RhPHxHzxXbkxlDlfoQXbFopCQUkE_bPO6plocDLZO75F';

  let discordUserId = null;

  // Login Discord - inicia OAuth2
  document.getElementById("loginBtn").addEventListener("click", () => {
    const url = `https://discord.com/api/oauth2/authorize?client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=token&scope=identify`;
    window.location.href = url;
  });

  // Logout
  document.getElementById("logoutBtn").addEventListener("click", () => {
    localStorage.removeItem("discord_token");
    location.reload();
  });

  function init() {
    const token = localStorage.getItem("discord_token");
    if (token) {
      fetch("https://discord.com/api/users/@me", {
        headers: {
          Authorization: `Bearer ${token}`,
        },
      })
      .then(res => {
        if (!res.ok) throw new Error("Token inv√°lido");
        return res.json();
      })
      .then(user => {
        discordUserId = user.id;
        // Mostrar form e esconder login
        document.getElementById("loginBtn").classList.add("d-none");
        document.getElementById("logoutBtn").classList.remove("d-none");
        document.getElementById("formContainer").classList.remove("d-none");
        document.getElementById("mainContent").classList.add("d-none");
      })
      .catch(() => {
        localStorage.removeItem("discord_token");
      });
    } else {
      // Tenta extrair token do hash da URL (OAuth2 Implicit Grant)
      const hash = window.location.hash;
      if (hash.includes("access_token")) {
        const params = new URLSearchParams(hash.substring(1));
        const accessToken = params.get("access_token");
        localStorage.setItem("discord_token", accessToken);
        window.location.hash = "";
        location.reload();
      }
    }
  }

  // Envio do formul√°rio
  document.getElementById("relatorioForm").addEventListener("submit", e => {
    e.preventDefault();

    if (!discordUserId) {
      alert("‚ö†Ô∏è Precisas estar autenticado para enviar o relat√≥rio.");
      return;
    }

    const idMedico = document.getElementById("medicoId").value.trim();
    const nomePaciente = document.getElementById("nomePaciente").value.trim();
    const idPaciente = document.getElementById("idPaciente").value.trim();
    const sintomas = document.getElementById("sintomas").value.trim();
    const medicamentos = document.getElementById("medicamentos").value.trim();
    const horario = document.getElementById("horario").value.trim();
    const dia = document.getElementById("dia").value.trim();

    const embed = {
      embeds: [{
        title: "üìã Novo Relat√≥rio de Consulta",
        color: 0x00ff00,
        fields: [
          { name: "üë®‚Äç‚öïÔ∏è Nome M√©dico", value: `<@${discordUserId}>`, inline: true },
          { name: "üÜî ID M√©dico", value: idMedico, inline: true },

          
          // Separador visual (campo em branco)
          { name: "\u200B", value: "\u200B" },
          
          { name: "üë§ Nome Paciente", value: nomePaciente, inline: true },
          { name: "üÜî ID Paciente", value: idPaciente, inline: true },
          { name: "ü§í Sintomas", value: sintomas, inline: false },
          { name: "üíä Medicamentos", value: medicamentos, inline: false },

          // Separador visual (campo em branco)
          { name: "\u200B", value: "\u200B" },
          
          { name: "üïí Hor√°rio", value: horario, inline: true },
          { name: "üìÖ Dia", value: dia, inline: true }
        ],
        timestamp: new Date().toISOString()
      }]
    };

    fetch(webhookURL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(embed),
    })
    .then(() => {
      alert("‚úÖ Relat√≥rio enviado com sucesso!");
      document.getElementById("relatorioForm").reset();
    })
    .catch(() => alert("‚ùå Erro ao enviar o relat√≥rio."));
  });

  window.onload = init;
</script>

</body>
</html>
